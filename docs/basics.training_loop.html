---

title: Visualizing the fastai Training Loop Further


keywords: fastai
sidebar: home_sidebar

summary: "Extending fastai's `show_training_loop` to be more verbose about event triggers"
description: "Extending fastai's `show_training_loop` to be more verbose about event triggers"
nb_path: "nbs/06_basics.training_loop.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/06_basics.training_loop.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/mnt/d/lib/python3.7/site-packages/torch/cuda/__init__.py:52: UserWarning: CUDA initialization: Found no NVIDIA driver on your system. Please check that you have an NVIDIA GPU and installed a driver from http://www.nvidia.com/Download/index.aspx (Triggered internally at  /pytorch/c10/cuda/CUDAFunctions.cpp:100.)
  return torch._C._cuda_getDeviceCount() &gt; 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea output_execute_result">
<hr>
<p>This article is also a Jupyter Notebook available to be run from the top down. There
will be code snippets that you can then run in any environment.</p>
<p>Below are the versions of <code>fastai</code>, <code>fastcore</code>, and <code>wwf</code> currently running at the time of writing this:</p>
<ul>
<li><code>fastai</code>: 2.2.5 </li>
<li><code>fastcore</code>: 1.3.19 </li>
<li><code>wwf</code>: 0.0.10 </li>
</ul>
<hr>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Understanding-fastai's-Training-Loop">Understanding fastai's Training Loop<a class="anchor-link" href="#Understanding-fastai's-Training-Loop"> </a></h2><p><code>fastai</code>'s training loop is certainly unique in its approach, where everything is handled through <code>Callbacks</code>. What this means is there should <em>never</em> be an instance where if you need to modify <code>fastai</code>'s training loop you are modifying <a href="https://docs.fast.ai/learner#Learner"><code>Learner</code></a>'s source code.</p>
<p>Instead we can use various trigger points through <code>Callbacks</code> to get there. Currently fastai has a methodology of showing just what <code>Callbacks</code> are called during the training loop through a function called <a href="/basics.training_loop.html#Learner.show_training_loop"><code>Learner.show_training_loop</code></a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="show_training_loop"><code>show_training_loop</code><a class="anchor-link" href="#show_training_loop"> </a></h2><p>The goal of <code>show_training_loop</code> is to show the user just what <code>Callbacks</code> are triggered during fastai's entire training cycle. An example is provided below:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.callback.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.test_utils</span> <span class="kn">import</span> <span class="n">synth_learner</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">show_training_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Start Fit
   - before_fit     : [TrainEvalCallback, Recorder, ProgressCallback]
  Start Epoch Loop
     - before_epoch   : [Recorder, ProgressCallback]
    Start Train
       - before_train   : [TrainEvalCallback, Recorder, ProgressCallback]
      Start Batch Loop
         - before_batch   : []
         - after_pred     : []
         - after_loss     : []
         - before_backward: []
         - before_step    : []
         - after_step     : []
         - after_cancel_batch: []
         - after_batch    : [TrainEvalCallback, Recorder, ProgressCallback]
      End Batch Loop
    End Train
     - after_cancel_train: [Recorder]
     - after_train    : [Recorder, ProgressCallback]
    Start Valid
       - before_validate: [TrainEvalCallback, Recorder, ProgressCallback]
      Start Batch Loop
         - **CBs same as train batch**: []
      End Batch Loop
    End Valid
     - after_cancel_validate: [Recorder]
     - after_validate : [Recorder, ProgressCallback]
  End Epoch Loop
   - after_cancel_epoch: []
   - after_epoch    : [Recorder]
End Fit
 - after_cancel_fit: []
 - after_fit      : [ProgressCallback]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As we can see, every major event is detailed with a <code>Start</code> and <code>Finish</code>, and the intermediate steps at each level are described. Paired with this are the <code>Callbacks</code> that get triggered at that particular event.</p>
<p>However, I think we can take this a step further to enable you to understand <em>just</em> what happens during each step. As a result, I've written a revised version of <a href="/basics.training_loop.html#Learner.show_training_loop"><code>Learner.show_training_loop</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.show_training_loop" class="doc_header"><code>Learner.show_training_loop</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/basics/training_loop.py#L50" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.show_training_loop</code>(<strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>cbs</code></strong>:<code>Union</code>[<code>NoneType</code>, <code>list</code>, <a href="https://docs.fast.ai/callback.core#Callback"><code>Callback</code></a>]=<em><code>None</code></em>)</p>
</blockquote>
<p>Show each step in the training loop, potentially with Callback event descriptions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With this new version we can pass in a <code>verbose</code> tag and for every <a href="https://docs.fast.ai/callback.core#Callback"><code>Callback</code></a> and its events we will pull its documentation string, so we can see what happens at each step as shown below:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_training_loop</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Start Fit
    - before_fit:
        - TrainEvalCallback: 
            - Set the iter and epoch counters to 0, put the model and the right device
        - Recorder: 
            - Prepare state for training
        - ProgressCallback: 
            - Setup the master bar over the epochs
   Start Epoch Loop
       - before_epoch:
           - Recorder: 
               - Set timer if `self.add_time=True`
           - ProgressCallback: 
               - Update the master bar
      Start Train
          - before_train:
              - TrainEvalCallback: 
                  - Set the model in training mode
              - Recorder: 
                  - Reset loss and metrics state
              - ProgressCallback: 
                  - Launch a progress bar over the training dataloader
         Start Batch Loop
             - before_batch:
             - after_pred:
             - after_loss:
             - before_backward:
             - before_step:
             - after_step:
             - after_cancel_batch:
             - after_batch:
                 - TrainEvalCallback: 
                     - Update the iter counter (in training mode)
                 - Recorder: 
                     - Update all metrics and records lr and smooth loss in training
                 - ProgressCallback: 
                     - Update the current progress bar
         End Batch Loop
      End Train
       - after_cancel_train:
           - Recorder: 
               - Ignore training metrics for this epoch
       - after_train:
           - Recorder: 
               - Log loss and metric values on the training set (if `self.training_metrics=True`)
           - ProgressCallback: 
               - Close the progress bar over the training dataloader
      Start Valid
          - before_validate:
              - TrainEvalCallback: 
                  - Set the model in validation mode
              - Recorder: 
                  - Reset loss and metrics state
              - ProgressCallback: 
                  - Launch a progress bar over the validation dataloader
         Start Batch Loop
             - **CBs same as train batch**:
         End Batch Loop
      End Valid
       - after_cancel_validate:
           - Recorder: 
               - Ignore validation metrics for this epoch
       - after_validate:
           - Recorder: 
               - Log loss and metric values on the validation set
           - ProgressCallback: 
               - Close the progress bar over the validation dataloader
   End Epoch Loop
    - after_cancel_epoch:
    - after_epoch:
        - Recorder: 
            - Store and log the loss/metric values
End Fit
 - after_cancel_fit:
 - after_fit:
     - ProgressCallback: 
         - Close the master bar
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Usage-Example:">Usage Example:<a class="anchor-link" href="#Usage-Example:"> </a></h2><p>To use this functionality, simply do:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">wwf.basics.training_loop</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And then call <code>learn.show_training_loop(verbose=True)</code></p>

</div>
</div>
</div>
</div>
 

